--- mujs/Makefile.orig	2016-04-14 21:02:05.000000000 +0200
+++ mujs/Makefile	2016-04-14 21:20:51.139270570 +0200
@@ -1,6 +1,6 @@
 SRCS := $(wildcard js*.c utf*.c regexp.c)
 HDRS := $(wildcard js*.h mujs.h utf.h regexp.h)
-OBJS := $(SRCS:%.c=build/%.o)
+LOBJS := $(SRCS:%.c=build/%.o)
 
 prefix ?= /usr/local
 bindir ?= $(prefix)/bin
@@ -8,6 +8,8 @@
 libdir ?= $(prefix)/lib
 
 CFLAGS := -std=c99 -pedantic -Wall -Wextra -Wno-unused-parameter
+LTCC = libtool --mode=compile --tag=CC $(CC)
+LTLINK = libtool --mode=link --tag=CC $(CC)
 
 ifeq "$(CC)" "clang"
 CFLAGS += -Wunreachable-code
@@ -44,11 +46,14 @@
 build/%.o: %.c $(HDRS)
 	$(CC) $(CFLAGS) -o $@ -c $<
 
-build/libmujs.a: $(OBJS)
-	$(AR) cru $@ $^
+build/%.lo: %.c $(HDRS)
+	$(LTCC) $(CFLAGS) -o $@ -c $<
 
-build/mujs: build/main.o build/libmujs.a
-	$(CC) $(LDFLAGS) -o $@ $^ -lm
+build/libmujs.la: $(LOBJS)
+	$(LTLINK) $(LDFLAGS) -o $@ $^ -rpath $(libdir) -lm
+
+build/mujs: build/main.o build/libmujs.la
+	$(LTLINK) $(LDFLAGS) -o $@ $^ -lm
 
 build/mujsone: build/main.o build/one.o
 	$(CC) $(LDFLAGS) -o $@ $^ -lm
@@ -58,8 +63,8 @@
 	install -d $(DESTDIR)$(libdir)
 	install -d $(DESTDIR)$(bindir)
 	install mujs.h $(DESTDIR)$(incdir)
-	install build/libmujs.a $(DESTDIR)$(libdir)
-	install build/mujs $(DESTDIR)$(bindir)
+	libtool --mode=install install build/libmujs.la $(DESTDIR)$(libdir)
+	libtool --mode=install install build/mujs $(DESTDIR)$(bindir)
 
 VERSION = $(shell git describe --tags --always)
 
